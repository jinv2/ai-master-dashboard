<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©ç®—AI Â· å•†ä¸šæƒ…æŠ¥ä¸­æ¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- å…œåº•æ ·å¼ (é˜²æ­¢ CSS åŠ è½½å¤±è´¥å¯¼è‡´ä¸‘é™‹) --- */
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; margin: 0; }
        .p-6 { padding: 24px; }
        .glass { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; }
        .text-center { text-align: center; }
        input, button { font-size: 16px; padding: 12px; border-radius: 6px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        input { background: #1e293b; border: 1px solid #475569; color: white; }
        button { background: #0891b2; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #06b6d4; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        .hidden { display: none !important; }
        .bar-container { background: #1e293b; height: 6px; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .bar-fill { background: #06b6d4; height: 100%; }
        /* ------------------------------------------- */
    </style>
</head>
<body>

    <div id="login-view" class="flex items-center justify-center h-screen" style="height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div class="glass p-6" style="max-width: 400px; width: 100%;">
            <h1 class="text-2xl font-bold mb-4 text-cyan-400 text-center" style="color: #22d3ee; margin-bottom: 20px;">SKYCALC CORE</h1>
            <p class="text-xs text-slate-500 mb-4 text-center" style="color: #94a3b8;">é›¶ä¾èµ–åŸç”Ÿæ¶æ„ v1.0</p>
            <input type="password" id="password-input" placeholder="è¾“å…¥è®¿é—®å¯†é’¥" onkeyup="if(event.key==='Enter') tryLogin()">
            <button id="login-btn" onclick="tryLogin()">éªŒè¯èº«ä»½</button>
            <p id="login-msg" style="color: #f87171; font-size: 12px; margin-top: 10px; display: none;"></p>
        </div>
    </div>

    <div id="dashboard-view" class="max-w-6xl mx-auto hidden" style="max-width: 1200px; margin: 0 auto;">
        <header class="flex justify-between items-center mb-8 border-b border-slate-700 pb-4" style="display: flex; justify-content: space-between; border-bottom: 1px solid #334155; margin-bottom: 30px; padding-bottom: 20px;">
            <h1 class="text-3xl font-bold text-white">å¤©ç®—AI <span class="text-cyan-400" style="color: #22d3ee;">å…¨å±€ç›‘æ§</span></h1>
            <div class="text-right">
                <div id="total-views" class="text-2xl font-mono text-cyan-400" style="font-family: monospace; font-size: 24px; color: #22d3ee;">0</div>
                <div class="text-xs text-slate-500" style="color: #94a3b8; font-size: 12px;">æ€»äº¤äº’æ¬¡æ•°</div>
            </div>
        </header>

        <div id="loading-text" class="text-center text-cyan-400 py-10" style="color: #22d3ee; text-align: center; padding: 40px;">æ­£åœ¨å»ºç«‹åŸç”Ÿè¿æ¥...</div>

        <div id="stats-grid" class="grid"></div>

        <div class="glass p-6 mt-12" style="margin-top: 50px; background: #0f172a; border: 1px dashed #334155;">
            <h3 class="font-bold text-white mb-2">ğŸ“¡ éƒ¨ç½²æŒ‡ä»¤</h3>
            <code class="block bg-black p-3 rounded text-green-400 text-xs break-all" style="background: black; color: #4ade80; display: block; padding: 10px; border-radius: 6px; font-family: monospace;">
                &lt;script src="https://ai-master-dashboard.netlify.app/inject-telemetry.js"&gt;&lt;/script&gt;
            </code>
        </div>
    </div>

    <script>
        // === é…ç½®åŒº ===
        const CONFIG = {
            url: 'https://sfxpbtqxtshtywbzahlo.supabase.co',
            key: 'sb_publishable_mMtaZpZiaW9FGK3XMkelug_piElFnC8',
            password: 'admin'
        };

        // === é€»è¾‘æ§åˆ¶ ===
        async function tryLogin() {
            const input = document.getElementById('password-input');
            const btn = document.getElementById('login-btn');
            const msg = document.getElementById('login-msg');
            
            msg.style.display = 'none';
            btn.innerText = 'è¿æ¥ä¸­...';

            if (input.value === CONFIG.password) {
                // åˆ‡æ¢è§†å›¾
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                // å¼€å§‹æ‹‰å–æ•°æ®
                await fetchData();
            } else {
                msg.innerText = 'å¯†é’¥é”™è¯¯';
                msg.style.display = 'block';
                btn.innerText = 'éªŒè¯èº«ä»½';
            }
        }

        async function fetchData() {
            const loading = document.getElementById('loading-text');
            const grid = document.getElementById('stats-grid');
            const totalEl = document.getElementById('total-views');

            try {
                // åŸç”Ÿ fetch è¯·æ±‚ï¼Œä¸ä¾èµ– supabase-js åº“
                const response = await fetch(`${CONFIG.url}/rest/v1/page_views?select=*&order=created_at.desc&limit=5000`, {
                    method: 'GET',
                    headers: {
                        'apikey': CONFIG.key,
                        'Authorization': `Bearer ${CONFIG.key}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`API é”™è¯¯: ${response.status}`);
                
                const rawData = await response.json();
                
                // å¤„ç†æ•°æ®
                loading.classList.add('hidden');
                totalEl.innerText = rawData.length;
                renderStats(rawData);

            } catch (err) {
                loading.innerText = "æ•°æ®è·å–å¤±è´¥: " + err.message;
                loading.style.color = "#f87171";
            }
        }

        function renderStats(data) {
            const stats = {};
            // æ•°æ®èšåˆé€»è¾‘
            data.forEach(r => {
                const name = r.site_name || 'Unknown';
                if (!stats[name]) stats[name] = { count: 0, lastActive: null };
                stats[name].count++;
                const t = new Date(r.created_at);
                if (!stats[name].lastActive || t > stats[name].lastActive) stats[name].lastActive = t;
            });

            // æ’åº
            const sorted = Object.entries(stats).sort(([,a],[,b]) => b.count - a.count);
            const total = data.length || 1;
            const grid = document.getElementById('stats-grid');
            
            let html = '';
            sorted.forEach(([name, val]) => {
                const percent = ((val.count / total) * 100).toFixed(1);
                const timeStr = val.lastActive ? val.lastActive.toLocaleString() : '-';
                
                html += `
                <div class="glass p-6">
                    <h3 class="font-bold text-xl text-white mb-2" style="font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</h3>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div>
                            <div class="text-xs text-slate-400" style="font-size: 0.75rem; color: #94a3b8;">ä½¿ç”¨æ¬¡æ•°</div>
                            <div class="text-2xl font-mono text-white" style="font-size: 1.5rem; font-family: monospace; color: white;">${val.count}</div>
                        </div>
                        <div class="text-right" style="text-align: right;">
                            <div class="text-xs text-slate-400" style="font-size: 0.75rem; color: #94a3b8;">æœ€åæ´»è·ƒ</div>
                            <div class="text-xs text-cyan-400" style="font-size: 0.75rem; color: #22d3ee;">${timeStr}</div>
                        </div>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: ${percent}%"></div>
                    </div>
                </div>
                `;
            });
            
            grid.innerHTML = html;
        }
    </script>
</body>
</html>
